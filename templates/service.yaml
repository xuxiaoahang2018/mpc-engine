{{- if .Values.company.enabled }}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ include "mobile-mpc.fullname" . }}-company-svc
  labels:
    {{- include "mobile-mpc.company.labels" . | nindent 4 }}
spec:
  type: {{ .Values.company.service.type }}
  ports:
  - port: {{ .Values.company.service.ports.spu }}
    targetPort: spu
    protocol: TCP
    name: spu
  - port: {{ .Values.company.service.ports.coordinator }}
    targetPort: coordinator
    protocol: TCP
    name: coordinator
  - port: {{ .Values.company.service.ports.ray }}
    targetPort: ray
    protocol: TCP
    name: ray
  - port: {{ .Values.company.service.ports.webui }}
    targetPort: webui
    protocol: TCP
    name: webui
  selector:
    {{- include "mobile-mpc.selectorLabels" . | nindent 4 }}
    app.kubernetes.io/component: company
{{- end }}

{{- if .Values.partner.enabled }}
---
# Partner Headless Service - DNS 返回 Pod IP 而不是 ClusterIP
# 这样 SPU Runtime 可以直接监听 Pod IP
apiVersion: v1
kind: Service
metadata:
  name: {{ include "mobile-mpc.fullname" . }}-partner-svc
  labels:
    {{- include "mobile-mpc.partner.labels" . | nindent 4 }}
spec:
  clusterIP: None  # Headless Service - 返回 Pod IP
  ports:
  - port: {{ .Values.partner.service.ports.spu }}
    targetPort: spu
    protocol: TCP
    name: spu
  selector:
    {{- include "mobile-mpc.selectorLabels" . | nindent 4 }}
    app.kubernetes.io/component: partner
{{- end }}

{{- if .Values.company.enabled }}
---
# Coordinator Service (指向 Company Pod，因为 Company 兼任 Coordinator)
apiVersion: v1
kind: Service
metadata:
  name: {{ include "mobile-mpc.fullname" . }}-coordinator-svc
  labels:
    {{- include "mobile-mpc.labels" . | nindent 4 }}
    app.kubernetes.io/component: coordinator
spec:
  type: ClusterIP
  ports:
  - port: {{ .Values.company.service.ports.coordinator }}
    targetPort: coordinator
    protocol: TCP
    name: coordinator
  selector:
    {{- include "mobile-mpc.selectorLabels" . | nindent 4 }}
    app.kubernetes.io/component: company
{{- end }}

{{- if .Values.webui.enabled }}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ include "mobile-mpc.fullname" . }}-webui
  labels:
    {{- include "mobile-mpc.webui.labels" . | nindent 4 }}
spec:
  type: {{ .Values.webui.service.type }}
  ports:
  - port: {{ .Values.webui.service.port }}
    targetPort: {{ .Values.webui.service.targetPort }}
    protocol: TCP
    name: http
    {{- if and (eq .Values.webui.service.type "NodePort") .Values.webui.service.nodePort }}
    nodePort: {{ .Values.webui.service.nodePort }}
    {{- end }}
  selector:
    {{- include "mobile-mpc.selectorLabels" . | nindent 4 }}
    app.kubernetes.io/component: webui
{{- end }}

