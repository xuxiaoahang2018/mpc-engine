{{- if .Values.partner.enabled }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "mobile-mpc.fullname" . }}-partner
  labels:
    {{- include "mobile-mpc.partner.labels" . | nindent 4 }}
    {{- with .Values.partner.extraLabels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
  {{- with .Values.partner.extraAnnotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  replicas: {{ .Values.partner.replicaCount }}
  selector:
    matchLabels:
      {{- include "mobile-mpc.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: partner
  template:
    metadata:
      labels:
        {{- include "mobile-mpc.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: partner
        {{- with .Values.partner.extraLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
      {{- with .Values.partner.extraAnnotations }}
      annotations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
    spec:
      {{- with .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      serviceAccountName: {{ include "mobile-mpc.serviceAccountName" . }}
      securityContext:
        {{- toYaml .Values.podSecurityContext | nindent 8 }}
      containers:
      - name: partner
        securityContext:
          {{- toYaml .Values.securityContext | nindent 10 }}
        image: {{ .Values.coordinator.image }}
        command: ["/bin/bash", "-c"]
        args:
          - |
            echo "ğŸš€ å¯åŠ¨ Partner èŠ‚ç‚¹..."
            
            # ğŸ”¥ æ¸…ç†æ—§çš„ Ray èµ„æºï¼ˆé˜²æ­¢ç«¯å£å†²çªå’Œè¿æ¥é—®é¢˜ï¼‰
            echo "ğŸ§¹ æ¸…ç†æ—§çš„ Ray Worker èµ„æº..."
            ray stop --force || true
            sleep 2
            
            # è®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆRay Worker éœ€è¦ï¼‰
            export JAX_PLATFORMS=cpu
            export XLA_FLAGS="--xla_force_host_platform_device_count=1 --xla_cpu_multi_thread_eigen=false"
            export OMP_NUM_THREADS=1
            export RAY_BACKEND_LOG_LEVEL=info
            
            # ä½¿ç”¨ Company Service åœ°å€è¿æ¥ Ray Head
            COMPANY_SERVICE="{{ include "mobile-mpc.fullname" . }}-company-svc"
            RAY_HEAD_ADDRESS="$COMPANY_SERVICE:{{ .Values.company.service.ports.ray }}"
            
            echo "ğŸ“ Ray Head åœ°å€: $RAY_HEAD_ADDRESS"
            echo "ğŸ“ èµ„æºæ ‡ç­¾: partner=10"
            echo "ğŸ“ CPU æ•°é‡: {{ .Values.partner.resources.requests.cpu | default 4 }}"
            
            # ç­‰å¾… Company èŠ‚ç‚¹å’Œ Ray Head å¯åŠ¨
            echo "â³ ç­‰å¾… Company Ray Head å‡†å¤‡å°±ç»ª..."
            MAX_RETRIES=30
            for i in $(seq 1 $MAX_RETRIES); do
              if nc -z $COMPANY_SERVICE {{ .Values.company.service.ports.ray }} 2>/dev/null || \
                 timeout 2 bash -c "echo > /dev/tcp/$COMPANY_SERVICE/{{ .Values.company.service.ports.ray }}" 2>/dev/null; then
                echo "âœ… Ray Head å·²å°±ç»ª"
                break
              fi
              if [ $i -eq $MAX_RETRIES ]; then
                echo "âš ï¸  Ray Head è¿æ¥æ£€æŸ¥è¶…æ—¶ï¼Œç»§ç»­å°è¯•è¿æ¥..."
              else
                echo "â³ ç­‰å¾… Ray Head... ($i/$MAX_RETRIES)"
                sleep 2
              fi
            done
            
            # å¯åŠ¨ Ray Worker èŠ‚ç‚¹ï¼ˆè‡ªåŠ¨é‡è¿å¾ªç¯ï¼‰
            echo "ğŸ¯ å¯åŠ¨ Ray Worker èŠ‚ç‚¹ï¼ˆPartnerï¼‰..."
            echo "ğŸ’¡ Ray Worker ä¼šåœ¨è¿æ¥æ–­å¼€æ—¶è‡ªåŠ¨é‡å¯å¹¶é‡æ–°è¿æ¥åˆ°æ–°çš„ Ray Head"
            echo ""
            
            # ğŸ”¥ å¾ªç¯å¯åŠ¨ Ray Workerï¼Œå®ç°è‡ªåŠ¨é‡è¿
            # å½“ Company Ray Head é‡å¯æ—¶ï¼ŒPartner Worker ä¼šè‡ªåŠ¨é‡æ–°è¿æ¥
            while true; do
                echo "â° $(date '+%Y-%m-%d %H:%M:%S') - å¯åŠ¨/é‡è¿ Ray Worker..."
                
                # æ¸…ç†æ—§çš„ Ray èµ„æº
                ray stop --force 2>/dev/null || true
                sleep 2
                
                # å¯åŠ¨ Ray Workerï¼ˆé˜»å¡æ¨¡å¼ï¼‰
                # å½“ Ray Head æ–­å¼€æ—¶ï¼Œraylet ä¼šé€€å‡ºï¼Œray start ä¹Ÿä¼šé€€å‡º
                ray start \
                  --address=$RAY_HEAD_ADDRESS \
                  --resources='{"partner": 10}' \
                  --num-cpus={{ .Values.partner.resources.requests.cpu | default 4 }} \
                  --block
                
                # å¦‚æœ ray start é€€å‡ºï¼ˆRay Head æ–­å¼€æˆ–å´©æºƒï¼‰
                EXIT_CODE=$?
                echo ""
                echo "âš ï¸  Ray Worker é€€å‡º (exit code: $EXIT_CODE)"
                echo "ğŸ”„ 5ç§’åè‡ªåŠ¨é‡å¯å¹¶é‡æ–°è¿æ¥..."
                sleep 5
            done
        ports:
        - name: spu
          containerPort: {{ .Values.partner.service.ports.spu }}
          protocol: TCP
        env:
        {{- include "mobile-mpc.commonEnv" . | nindent 8 }}
        {{- with .Values.partner.env }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        volumeMounts:
        - name: data
          mountPath: /app/data
        - name: models
          mountPath: /app/partner/models
        - name: logs
          mountPath: /app/logs
        {{- if .Values.global.resourcesEnabled }}
        resources:
          {{- toYaml .Values.partner.resources | nindent 10 }}
        {{- end }}
      volumes:
      {{- include "mobile-mpc.volumes" .Values.partner | nindent 6 }}
      {{- with .Values.partner.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- if .Values.global.affinityEnabled }}
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: {{ .Values.global.affinity.key }}
                operator: In
                values:
                {{- toYaml .Values.global.affinity.values | nindent 16 }}
      {{- else }}
        {{- with .Values.partner.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
        {{- end }}
      {{- end }}
      {{- with .Values.partner.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
{{- end }}

