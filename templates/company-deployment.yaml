{{- if .Values.company.enabled }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "mobile-mpc.fullname" . }}-company
  labels:
    {{- include "mobile-mpc.company.labels" . | nindent 4 }}
    {{- with .Values.company.extraLabels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
  {{- with .Values.company.extraAnnotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  replicas: {{ .Values.company.replicaCount }}
  selector:
    matchLabels:
      {{- include "mobile-mpc.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: company
  template:
    metadata:
      labels:
        {{- include "mobile-mpc.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: company
        {{- with .Values.company.extraLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
      {{- with .Values.company.extraAnnotations }}
      annotations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
    spec:
      {{- with .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      serviceAccountName: {{ include "mobile-mpc.serviceAccountName" . }}
      securityContext:
        {{- toYaml .Values.podSecurityContext | nindent 8 }}
      containers:
      - name: company
        securityContext:
          {{- toYaml .Values.securityContext | nindent 10 }}
        image: {{ .Values.coordinator.image }}
        command: ["/bin/bash", "-c"]
        args:
          - |
            echo "ğŸš€ å¯åŠ¨ Company èŠ‚ç‚¹..."
            
            # è·å– Pod IP
            export POD_IP=$(hostname -i)
            echo "ğŸ“ Pod IP: $POD_IP"
            
            # ä½¿ç”¨ Ray CLI å¯åŠ¨ Ray Headï¼ˆæŒ‡å®šç«¯å£ 6379ï¼‰
            echo "ğŸ“ å¯åŠ¨ Ray Head (ç«¯å£: {{ .Values.company.service.ports.ray }})..."
            ray start --head \
              --port={{ .Values.company.service.ports.ray }} \
              --num-cpus={{ .Values.company.resources.requests.cpu | default 8 }} \
              --resources='{"company": 10, "coordinator": 10}' \
              --object-store-memory=2000000000 \
              --include-dashboard=false \
              --node-ip-address=$POD_IP &
            
            RAY_PID=$!
            echo "Ray Head åå°è¿›ç¨‹ PID: $RAY_PID"
            
            # ç­‰å¾… Ray Head å¯åŠ¨
            echo "â³ ç­‰å¾… Ray Head å‡†å¤‡å°±ç»ª..."
            sleep 5
            
            # éªŒè¯ Ray Head æ˜¯å¦å¯åŠ¨æˆåŠŸ
            if ! ray status &>/dev/null; then
              echo "âš ï¸  Ray Head å¯åŠ¨æ£€æŸ¥å¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œ..."
            else
              echo "âœ… Ray Head å·²å¯åŠ¨"
            fi
            
            # è§£æ Partner Service çš„ Pod IP
            echo "ğŸ” è§£æ Partner Service åœ°å€..."
            PARTNER_SERVICE_NAME="{{ include "mobile-mpc.fullname" . }}-partner-svc"
            PARTNER_IP=$(getent hosts $PARTNER_SERVICE_NAME | awk '{ print $1 }' | head -1)
            if [ -z "$PARTNER_IP" ]; then
              echo "âš ï¸  æ— æ³•è§£æ Partner Serviceï¼Œä½¿ç”¨ Service åç§°"
              PARTNER_SPU_ADDR="{{ .Values.company.partnerSpuAddr }}"
            else
              echo "âœ… Partner IP: $PARTNER_IP"
              PARTNER_SPU_ADDR="$PARTNER_IP:{{ .Values.partner.service.ports.spu }}"
            fi
            
            # ğŸ”¥ ä¿®æ”¹ï¼šä¸è‡ªåŠ¨æ‰§è¡Œè®­ç»ƒï¼Œç­‰å¾… Web UI é€šè¿‡ä¿®æ”¹ Deployment args æ¥å¯åŠ¨è®­ç»ƒ
            echo "âœ… Company èŠ‚ç‚¹å·²å°±ç»ªï¼Œç­‰å¾… Web UI å¯åŠ¨è®­ç»ƒä»»åŠ¡..."
            echo "ğŸ“ Ray Head åœ°å€: $POD_IP:{{ .Values.company.service.ports.ray }}"
            echo "ğŸ“ Partner SPU åœ°å€: $PARTNER_SPU_ADDR"
            echo ""
            echo "ğŸ’¡ æç¤ºï¼šè®­ç»ƒä»»åŠ¡å°†ç”± Web UI é€šè¿‡ Kubernetes API åŠ¨æ€æ³¨å…¥"
            echo "ğŸ’¡ æç¤ºï¼šWeb UI ä¼šä¿®æ”¹æ­¤ Deployment çš„ argsï¼Œæ·»åŠ è®­ç»ƒå‘½ä»¤å¹¶é‡å¯ Pod"
            
            # ä¿æŒ Pod è¿è¡Œï¼ˆç­‰å¾…è®­ç»ƒå‘½ä»¤ï¼‰
            # Web UI ä¼šé€šè¿‡ä¿®æ”¹ Deployment args æ¥æ·»åŠ è®­ç»ƒå‘½ä»¤
            tail -f /dev/null
        ports:
        - name: spu
          containerPort: {{ .Values.company.service.ports.spu }}
          protocol: TCP
        - name: coordinator
          containerPort: 9396
          protocol: TCP
        - name: ray
          containerPort: {{ .Values.company.service.ports.ray }}
          protocol: TCP
        - name: webui
          containerPort: {{ .Values.company.service.ports.webui }}
          protocol: TCP
        env:
        {{- include "mobile-mpc.commonEnv" . | nindent 8 }}
        {{- with .Values.company.env }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        volumeMounts:
        - name: data
          mountPath: /app/data
        - name: models
          mountPath: /app/company/models
        - name: logs
          mountPath: /app/logs
        - name: dshm
          mountPath: /dev/shm
        {{- if .Values.global.resourcesEnabled }}
        resources:
          {{- toYaml .Values.company.resources | nindent 10 }}
        {{- end }}
      volumes:
      {{- include "mobile-mpc.volumes" .Values.company | nindent 6 }}
      - name: dshm
        emptyDir:
          medium: Memory
          sizeLimit: 2Gi
      {{- with .Values.company.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- if .Values.global.affinityEnabled }}
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: {{ .Values.global.affinity.key }}
                operator: In
                values:
                {{- toYaml .Values.global.affinity.values | nindent 16 }}
      {{- else }}
        {{- with .Values.company.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
        {{- end }}
      {{- end }}
      {{- with .Values.company.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
{{- end }}

